<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symbol Transfer</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://xembook.github.io/nem2-browserify/symbol-sdk-2.0.4.js"></script>
</head>
<body>
    <div id="main-content-wrapper">
        <header>
            <button id="toggleTableOfContents"><img src="XYM.png" alt="Fitness Logo"></button>
            <ul id="tableOfContents" class="hidden">
                <li><a href="https://symbol-community.com/ja/docs/1">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆä½œæˆ</a></li>
                <li><a href="https://ishidad2.github.io/ShareZAP/?address=">ShareZAP</a></li>
            </ul>
        </header>

        <div class="container">   
            <p id="siteDescription">ã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã¯ç­‹ãƒˆãƒ¬ã‚’ä¿ƒã™ç‰¹åˆ¥ãªå ´æ‰€ã§ã™ã€‚<br>ã‚ãªãŸã®SYMBOLã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ç­‹ãƒˆãƒ¬å›æ•°ã‚’å…¥åŠ›ã—ã€<br>ã€Œç­‹ãƒˆãƒ¬å ±é…¬ç²å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒç™ºç”Ÿã—ã€<br>ç­‹ãƒˆãƒ¬å›æ•°ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨KINNIKU-TOKENãŒè´ˆã‚‰ã‚Œã¾ã™ã€‚</p>
            
            <form id="transferForm">
                <label for="recipientAddress">å—ä¿¡è€…ã®SYMBOLã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="text" id="recipientAddress" name="recipientAddress" required>
                
                <label for="amount">ç­‹ãƒˆãƒ¬å›æ•°:</label>
                <input type="number" id="amount" name="amount" required>
                
                <button type="button" onclick="createAndSendTransaction()">ç­‹ãƒˆãƒ¬å ±é…¬ã‚’ç²å¾—</button>
            </form>

            <div class="new-user-guide">
                <button id="toggle-guide-button">Symbolã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ã“ã¡ã‚‰</button>
                <div id="guide-content" class="hidden">
                    <h4>KINNIKU-TOKENã‚’å—ã‘å–ã‚‹ã«ã¯ï¼Ÿ</h4>
                    <p>KINNIKU-TOKENã‚„å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹ã«ã¯ã€ã€ŒSymbolã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¨ã„ã†ã€ã‚ãªãŸå°‚ç”¨ã®ãƒ‡ã‚¸ã‚¿ãƒ«ã®å—ã‘å–ã‚Šå ´æ‰€ãŒå¿…è¦ã§ã™ã€‚</p>
                    <p>ã“ã‚Œã¯éŠ€è¡Œã®å£åº§ç•ªå·ã®ã‚ˆã†ãªã‚‚ã®ã§ã€å®‰å…¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿ç®¡ã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã¾ã™ã€‚</p>
                    <a href="https://symbol-community.com/ja/docs/1" target="_blank" rel="noopener noreferrer">ã“ã¡ã‚‰ã®å…¬å¼ã‚µã‚¤ãƒˆã®æ¡ˆå†…ã«æ²¿ã£ã¦ã€ã‚¦ã‚©ãƒ¬ãƒƒãƒˆï¼ˆãŠè²¡å¸ƒï¼‰ã‚’ä½œæˆã—ã€ã‚ãªãŸã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚</a>
                    <p>ä½œæˆã¯æ•°åˆ†ã§å®Œäº†ã—ã¾ã™ï¼</p>
                </div>
            </div>

            <p id="tokenBalance">ä¿æœ‰ãƒˆãƒ¼ã‚¯ãƒ³æ•°é‡: 0 KINNIKU-TOKEN</p>
        
            <div id="transactionDetails">
                <p id="message">message: </p>
            </div>
        </div>
    </div>

    <button id="peek-button">ğŸ‘ï¸</button>

    <script>
        // --- Frontend Logic ---
        const NODE = 'https://xym.jp1.node.leywapool.com:3001';
        const sym = require("/node_modules/symbol-sdk");
        const repo = new sym.RepositoryFactoryHttp(NODE);

        async function createAndSendTransaction() {
            const recipientAddressValue = document.getElementById('recipientAddress').value;
            const amountValue = document.getElementById('amount').value;

            if (!recipientAddressValue || !amountValue || amountValue <= 0) {
                alert("å—ä¿¡è€…ã®SYMBOLã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ç­‹ãƒˆãƒ¬å›æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            try {
                sym.Address.createFromRawAddress(recipientAddressValue);
            } catch (error) {
                alert("ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ã€‚");
                return;
            }

            const button = document.querySelector('#transferForm button');
            button.disabled = true;
            button.textContent = 'å‡¦ç†ä¸­...';

            try {
                const response = await fetch('/api/send-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        recipientAddress: recipientAddressValue, 
                        amount: parseInt(amountValue) 
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    alert("ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼");
                    document.getElementById('message').textContent = `message: ${data.transactionMessage}`;
                    getAndDisplayTokenBalance(recipientAddressValue);
                } else {
                    throw new Error(data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }

            } catch (error) {
                console.error("APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'ç­‹ãƒˆãƒ¬å ±é…¬ã‚’ç²å¾—';
            }
        }

        async function getAndDisplayTokenBalance(address) {
            const tokenId = '44FD959F9F2ECF4D';
            if (!address) return;

            try {
                const accountHttp = repo.createAccountRepository();
                const accountAddress = sym.Address.createFromRawAddress(address);
                const accountInfo = await accountHttp.getAccountInfo(accountAddress).toPromise();
                const tokenBalance = accountInfo.mosaics.find(mosaic => mosaic.id.toHex() === tokenId);

                const tokenBalanceElement = document.getElementById('tokenBalance');
                const bodyElement = document.body;
                
                bodyElement.className = '';

                if (tokenBalance) {
                    const tokenCount = tokenBalance.amount.compact();
                    tokenBalanceElement.textContent = `ä¿æœ‰ãƒˆãƒ¼ã‚¯ãƒ³æ•°é‡: ${tokenCount} KINNIKU-TOKEN`;

                    if (tokenCount >= 0 && tokenCount <= 200) bodyElement.classList.add('background-0');
                    else if (tokenCount <= 300) bodyElement.classList.add('background-1');
                    else if (tokenCount <= 400) bodyElement.classList.add('background-2');
                    else if (tokenCount <= 500) bodyElement.classList.add('background-3');
                    else if (tokenCount <= 1000) bodyElement.classList.add('background-4');
                    else if (tokenCount <= 1500) bodyElement.classList.add('background-5');
                    else if (tokenCount <= 2000) bodyElement.classList.add('background-6');
                    else if (tokenCount <= 2500) bodyElement.classList.add('background-7');
                    else if (tokenCount <= 3000) bodyElement.classList.add('background-8');
                    else bodyElement.classList.add('background-9');
                    
                } else {
                    tokenBalanceElement.textContent = 'ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿æœ‰ã—ã¦ã„ã¾ã›ã‚“';
                    bodyElement.classList.add('background-0');
                }
            } catch (error) {
                console.error(error);
                document.getElementById('tokenBalance').textContent = 'ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™';
                document.body.className = 'background-0';
            }
        }

        function updateBackground() {
            const recipientAddress = document.getElementById('recipientAddress').value;
            getAndDisplayTokenBalance(recipientAddress);
        }

        // --- Event Listeners ---
        window.addEventListener('load', function () {
            // Background update logic
            updateBackground();
            document.getElementById('recipientAddress').addEventListener('input', updateBackground);

            // Toggle logic
            document.getElementById('toggleTableOfContents').addEventListener('click', function() {
                document.getElementById('tableOfContents').classList.toggle('hidden');
            });

            // New user guide toggle logic
            document.getElementById('toggle-guide-button').addEventListener('click', function() {
                document.getElementById('guide-content').classList.toggle('hidden');
            });

            // Peek button logic
            const peekButton = document.getElementById('peek-button');
            const contentWrapper = document.getElementById('main-content-wrapper');

            const hideContent = () => contentWrapper.classList.add('fade-out');
            const showContent = () => contentWrapper.classList.remove('fade-out');

            peekButton.addEventListener('mousedown', hideContent);
            peekButton.addEventListener('mouseup', showContent);
            peekButton.addEventListener('mouseleave', showContent);
            peekButton.addEventListener('touchstart', hideContent, { passive: true });
            peekButton.addEventListener('touchend', showContent);
        });
    </script>
</body>
</html>